<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pCloud Backup ‚Äì Timing Diagram (Pr√§zise)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #0a0e27;
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
            overflow-x: auto;
        }

        .container {
            max-width: 2000px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
            border-bottom: 2px solid #4ac8ae;
        }

        h1 {
            font-size: 2rem;
            color: #4ac8ae;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #a0a0a0;
            font-size: 0.95rem;
        }

        .diagram {
            background: #1a1a2e;
            border: 1px solid #4ac8ae;
            border-radius: 8px;
            padding: 0;
            overflow-x: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .timeline {
            display: flex;
            min-width: fit-content;
        }

        .time-column {
            flex-shrink: 0;
            width: 60px;
            border-right: 2px solid #4ac8ae;
            background: #0f0f1e;
            padding: 0;
        }

        .time-label {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            font-weight: bold;
            color: #4ac8ae;
            border-bottom: 1px solid #333;
        }

        .time-tick {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: #666;
            border-bottom: 1px dashed #333;
        }

        .components {
            display: flex;
            flex-shrink: 0;
        }

        .component {
            flex-shrink: 0;
            width: 150px;
            border-right: 2px solid #333;
        }

        .component-header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background: linear-gradient(135deg, #1a3a3a 0%, #0f2a2a 100%);
            border-bottom: 2px solid #4ac8ae;
            font-size: 0.9rem;
            text-align: center;
            padding: 10px;
            min-height: 60px;
            color: #4ac8ae;
            flex-wrap: wrap;
        }

        .component-line {
            flex: 1;
            border-left: 2px dashed #4ac8ae;
            margin-left: 50%;
            position: relative;
        }

        .event {
            position: relative;
            margin: 0;
            padding: 0;
        }

        .event-box {
            position: absolute;
            left: -70px;
            width: 140px;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            text-align: center;
            border: 1px solid;
            font-weight: 500;
            z-index: 10;
            white-space: pre-wrap;
            word-wrap: break-word;
            line-height: 1.2;
        }

        .event-action {
            background: #2a5a5a;
            border-color: #4ac8ae;
            color: #4ac8ae;
        }

        .event-decision-green {
            background: #2d5a2d;
            border-color: #4caf50;
            color: #4caf50;
        }

        .event-decision-red {
            background: #5a2d2d;
            border-color: #ff5252;
            color: #ff5252;
        }

        .event-decision-yellow {
            background: #5a5a2d;
            border-color: #ffc107;
            color: #ffc107;
        }

        .event-row {
            display: flex;
            min-width: fit-content;
        }

        .time-cell {
            width: 60px;
            border-bottom: 1px dashed #333;
            flex-shrink: 0;
        }

        .component-cell {
            width: 150px;
            height: 50px;
            border-bottom: 1px dashed #333;
            border-right: 1px solid #333;
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ac8ae;
            z-index: 5;
        }

        .arrow {
            position: absolute;
            height: 2px;
            background: #ff9800;
            z-index: 3;
            display: flex;
            align-items: center;
        }

        .arrow::after {
            content: '';
            position: absolute;
            right: -6px;
            width: 0;
            height: 0;
            border-left: 6px solid #ff9800;
            border-top: 3px solid transparent;
            border-bottom: 3px solid transparent;
        }

        .arrow-label {
            position: absolute;
            font-size: 0.7rem;
            background: #1a1a2e;
            padding: 2px 4px;
            color: #ff9800;
            font-weight: bold;
            top: -12px;
            white-space: nowrap;
        }

        .time-label-big {
            font-size: 0.9rem;
            font-weight: bold;
            color: #4ac8ae;
            padding: 20px 0 10px 0;
            text-align: center;
            border-top: 2px solid #4ac8ae;
            margin-top: 10px;
        }

        .section-label {
            position: absolute;
            left: 70px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #ffc107;
            background: #1a1a2e;
            padding: 2px 6px;
            border: 1px solid #ffc107;
            border-radius: 3px;
            z-index: 20;
        }

        .legend {
            margin-top: 30px;
            padding: 20px;
            background: #1a1a2e;
            border: 1px solid #4ac8ae;
            border-radius: 8px;
        }

        .legend h3 {
            color: #4ac8ae;
            margin-bottom: 15px;
        }

        .legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .legend-item {
            padding: 10px;
            background: rgba(74, 200, 174, 0.1);
            border-left: 3px solid #4ac8ae;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .legend-label {
            font-weight: bold;
            color: #4ac8ae;
            margin-bottom: 5px;
        }

        .legend-desc {
            color: #a0a0a0;
            font-size: 0.8rem;
        }

        .info-section {
            margin-top: 40px;
            padding: 20px;
            background: #1a1a2e;
            border: 1px solid #4ac8ae;
            border-radius: 8px;
        }

        .info-section h3 {
            color: #4ac8ae;
            margin-bottom: 15px;
        }

        .info-section p {
            color: #e0e0e0;
            line-height: 1.6;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        code {
            background: #0a0e27;
            padding: 2px 6px;
            border-radius: 3px;
            color: #4ac8ae;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        .critical {
            background: rgba(255, 82, 82, 0.1);
            border-left: 3px solid #ff5252;
            color: #ff5252;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #4ac8ae;
            color: #808080;
            font-size: 0.85rem;
        }

        .row-label {
            position: absolute;
            left: -55px;
            font-size: 0.75rem;
            color: #ffc107;
            font-weight: bold;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üîí pCloud Backup ‚Äì Timing Diagram (Pr√§zise)</h1>
            <div class="subtitle">Systemd Services, Lock-Mechanik & Sequenzablauf</div>
        </header>

        <div class="diagram">
            <div class="timeline">
                <!-- Time Column -->
                <div class="time-column">
                    <div class="time-label">TIME</div>
                    <div class="time-tick">00:00</div>
                    <div class="time-tick">00:30</div>
                    <div class="time-tick">01:00</div>
                    <div class="time-tick">01:30</div>
                    <div class="time-tick">02:00</div>
                    <div class="time-tick">02:05</div>
                    <div class="time-tick">02:10</div>
                    <div class="time-tick">02:15</div>
                    <div class="time-tick">02:20</div>
                    <div class="time-tick">02:25</div>
                    <div class="time-tick">02:30</div>
                    <div class="time-tick">02:35</div>
                    <div class="time-tick">03:00</div>
                </div>

                <!-- Components -->
                <div class="components">
                    <!-- Component 1: Systemd Timer -->
                    <div class="component">
                        <div class="component-header">Systemd<br/>Timer</div>
                        <div class="component-line">
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px; position: relative;">
                                <div class="dot" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                <div class="event-box event-action" style="top: -30px;">üîî Timer Fires<br/>02:00 AM</div>
                            </div>
                            <div style="height: 50px; position: relative;">
                                <div class="arrow" style="width: 60px; top: 50%; left: 150%;"></div>
                            </div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                        </div>
                    </div>

                    <!-- Component 2: RTB Wrapper -->
                    <div class="component">
                        <div class="component-header">RTB<br/>Wrapper</div>
                        <div class="component-line">
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px; position: relative;">
                                <div class="dot" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                <div class="event-box event-action" style="top: -20px;">START</div>
                            </div>
                            <div style="height: 50px; position: relative;">
                                <div class="event-box event-action" style="top: 0px; left: -85px; width: 170px;">‚õî Lock Check<br/>Try: acquire</div>
                            </div>
                            <div style="height: 50px; position: relative;">
                                <div class="event-box event-action" style="top: 0px; left: -85px; width: 170px;">Safety-Gate<br/>Query Status</div>
                            </div>
                            <div style="height: 50px; position: relative;">
                                <div class="event-box event-action" style="top: -30px;">‚è±Ô∏è DRY-RUN<br/>√Ñnderungen?</div>
                            </div>
                            <div style="height: 50px; position: relative;">
                                <div class="event-box event-action" style="top: 0px; left: -85px; width: 170px;">‚ñ∂Ô∏è RTB Start<br/>rsync_tmbackup</div>
                            </div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px; position: relative;">
                                <div class="event-box event-action" style="top: 0px; left: -85px; width: 170px;">‚ñ∂Ô∏è pCloud-Sync<br/>START</div>
                            </div>
                            <div style="height: 50px; position: relative;">
                                <div class="event-box event-action" style="top: -30px;">‚úÖ DONE<br/>Lock Release</div>
                            </div>
                        </div>
                    </div>

                    <!-- Component 3: Safety-Gate / MariaDB -->
                    <div class="component">
                        <div class="component-header">Safety-Gate<br/>(EntropyWatcher)</div>
                        <div class="component-line">
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px; position: relative;">
                                <div class="dot" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                <div class="arrow" style="width: 60px; top: 50%; left: 150%; transform: rotate(180deg);"></div>
                                <div class="event-box event-decision-green" style="top: -30px;">üü¢ GREEN<br/>OK</div>
                            </div>
                            <div style="height: 50px; position: relative;">
                                <div class="arrow" style="width: 60px; top: 50%; left: 150%; transform: rotate(180deg);"></div>
                            </div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                        </div>
                    </div>

                    <!-- Component 4: rsync_tmbackup -->
                    <div class="component">
                        <div class="component-header">rsync<br/>_tmbackup</div>
                        <div class="component-line">
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px; position: relative;">
                                <div class="dot" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                <div class="event-box event-action" style="top: -40px; left: -85px; width: 170px;">üîÑ Snapshot<br/>Hardlinks<br/>Kopieren</div>
                            </div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px; position: relative;">
                                <div class="event-box event-action" style="top: -20px;">‚úÖ DONE</div>
                            </div>
                            <div style="height: 50px;"></div>
                        </div>
                    </div>

                    <!-- Component 5: Manifest / pCloud -->
                    <div class="component">
                        <div class="component-header">Manifest<br/>& pCloud</div>
                        <div class="component-line">
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px; position: relative;">
                                <div class="dot" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                <div class="event-box event-action" style="top: -40px; left: -85px; width: 170px;">SHA256<br/>Manifest<br/>Gen</div>
                            </div>
                            <div style="height: 50px; position: relative;">
                                <div class="event-box event-action" style="top: 0px; left: -85px; width: 170px;">Upload<br/>NEW/CHANGED<br/>Dedup</div>
                            </div>
                            <div style="height: 50px; position: relative;">
                                <div class="event-box event-action" style="top: -30px;">‚úÖ Done<br/>Index</div>
                            </div>
                            <div style="height: 50px;"></div>
                        </div>
                    </div>

                    <!-- Component 6: MariaDB -->
                    <div class="component">
                        <div class="component-header">MariaDB<br/>(Logs)</div>
                        <div class="component-line">
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px; position: relative;">
                                <div class="arrow" style="width: 60px; top: 50%; left: -150%;"></div>
                            </div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px; position: relative;">
                                <div class="dot" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);"></div>
                                <div class="event-box event-action" style="top: -30px;">üìù Log<br/>Success</div>
                            </div>
                            <div style="height: 50px;"></div>
                            <div style="height: 50px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="info-section">
            <h3>üìã Detaillierter Ablauf (t=02:00 bis t=02:35)</h3>
            <p><strong>02:00:00</strong> ‚Äì Systemd Timer triggert <code>rtb_wrapper.sh</code></p>
            <p><strong>02:00:01</strong> ‚Äì Lock-Datei pr√ºfen: <code>/run/backup_pipeline.lock</code></p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚úì Lock erfolgreich acquired (Verhindert Parallelit√§t)</p>
            
            <p><strong>02:00:02</strong> ‚Äì Safety-Gate Check: <code>safety_gate.sh --strict</code></p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí Query MariaDB: flagged=0, av_findings=0, age_min ok?</p>
            <p style="margin-left: 20px; color: #4caf50;">‚úì GREEN (Exit 0) ‚Äì Backup erlaubt</p>
            
            <p><strong>02:00:05</strong> ‚Äì Dry-Run Check: rsync vergleicht SRC vs latest</p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí <code>rsync -ni --delete /srv/nas/ latest/ | grep -q '^[&lt;>ch*]'</code></p>
            <p style="margin-left: 20px; color: #4caf50;">‚úì √Ñnderungen erkannt ‚Üí RTB l√§uft</p>
            
            <p><strong>02:00:06</strong> ‚Äì RTB (rsync_tmbackup.sh) STARTS</p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí Erstellt Snapshot: <code>/mnt/backup/rtb_nas/2025-11-24-120000/</code></p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí Hardlinks f√ºr unver√§nderte Dateien</p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí Latest symlink aktualisiert</p>
            
            <p><strong>02:20:00</strong> ‚Äì RTB FERTIG (Exit 0)</p>
            <p style="margin-left: 20px; color: #4caf50;">‚úì Snapshot erfolgreich</p>
            
            <p><strong>02:20:05</strong> ‚Äì pCloud-Sync START (Automatisch, Lock NOCH GEHALTEN!)</p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí Preflight: Quota/Auth/Reachability Check</p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí Safety-Delay 120s (warte nach RTB)</p>
            
            <p><strong>02:22:00</strong> ‚Äì Manifest generieren (SHA256 pro Datei)</p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí <code>pcloud_json_manifest.py</code></p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí Output: <code>manifest.json</code> mit allen Hashes</p>
            
            <p><strong>02:25:00</strong> ‚Äì Upload zu pCloud mit Deduplication</p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí Pr√ºfe <code>content_index.json</code></p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí Nur NEW/CHANGED hochladen (85% Ersparnis!)</p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí content_index.json aktualisieren</p>
            
            <p><strong>02:35:00</strong> ‚Äì pCloud-Sync FERTIG (Exit 0)</p>
            <p style="margin-left: 20px; color: #4caf50;">‚úì Upload erfolgreich</p>
            
            <p><strong>02:35:01</strong> ‚Äì Log Eintrag in MariaDB</p>
            <p style="margin-left: 20px; color: #4ac8ae;">‚Üí Pipeline Success</p>
            
            <p><strong>02:35:02</strong> ‚Äì Lock RELEASED</p>
            <p style="margin-left: 20px; color: #4caf50;">‚úì Pipeline komplett!</p>
        </div>

        <div class="info-section">
            <h3>üîÄ Alternativ: Fehlerszenarien</h3>
            <p><strong style="color: #ff5252;">Scenario 1: Safety-Gate RED</strong></p>
            <p style="margin-left: 20px;">02:00:02 ‚Äì Ransomware erkannt (flagged&gt;0)</p>
            <p style="margin-left: 20px; color: #ff5252;">‚Üí Exit 2 (RED) ‚Äì ABORT!</p>
            <p style="margin-left: 20px; color: #ff5252;">‚Üí RTB & pCloud √ºberspringen</p>
            <p style="margin-left: 20px; color: #ff5252;">‚Üí Lock released, Alert Admin</p>
            
            <p style="margin-top: 15px;"><strong style="color: #ffc107;">Scenario 2: Keine √Ñnderungen</strong></p>
            <p style="margin-left: 20px;">02:00:05 ‚Äì DRY-RUN: Keine Matches (kein &lt;>ch*)</p>
            <p style="margin-left: 20px; color: #ffc107;">‚Üí RTB √ºberspringen (NO_CHANGE_EXIT0=1)</p>
            <p style="margin-left: 20px; color: #ffc107;">‚Üí Lock released (Exit 0 ‚Äì graceful)</p>
            
            <p style="margin-top: 15px;"><strong style="color: #ffc107;">Scenario 3: Lock busy</strong></p>
            <p style="margin-left: 20px;">02:00:01 ‚Äì Kann Lock nicht in 2h akquirieren</p>
            <p style="margin-left: 20px; color: #ffc107;">‚Üí EXIT 0 (skip) ‚Äì verhindert Deadlock</p>
        </div>

        <div class="info-section critical">
            <h3>‚ö†Ô∏è Kritische Punkte</h3>
            <p><strong>1. Shared Lock</strong> ‚Äì Selbes Lockfile f√ºr RTB & pCloud verhindert Parallelit√§t</p>
            <p><strong>2. Zwei Gating-Ebenen</strong> ‚Äì Safety-Gate + DRY-RUN = doppelte Absicherung</p>
            <p><strong>3. Automatische Verkettung</strong> ‚Äì pCloud startet sofort nach RTB, Lock NOCH gehalten</p>
            <p><strong>4. Graceful Timeouts</strong> ‚Äì Lock Timeout 2h, kein Hard-Abort, immer LOCKFILE released</p>
            <p><strong>5. DB-Konsistenz</strong> ‚Äì Alle Events werden geloggt (MariaDB) f√ºr Audit Trail</p>
        </div>

        <div class="legend">
            <h3>üé® Legende</h3>
            <div class="legend-grid">
                <div class="legend-item">
                    <div class="legend-label">üîî Timer Fires</div>
                    <div class="legend-desc">Systemd Timer triggert Service (2:00 AM)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-label">‚õî Lock Check</div>
                    <div class="legend-desc">Acquire /run/backup_pipeline.lock (max 2h wait)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-label">üü¢ GREEN</div>
                    <div class="legend-desc">Safety-Gate OK, Backup erlaubt</div>
                </div>
                <div class="legend-item">
                    <div class="legend-label">üü° YELLOW</div>
                    <div class="legend-desc">Warning (strict=1 blockiert trotzdem)</div>
                </div>
                <div class="legend-item">
                    <div class="legend-label">üî¥ RED</div>
                    <div class="legend-desc">Ransomware/Viren erkannt, ABORT</div>
                </div>
                <div class="legend-item">
                    <div class="legend-label">‚è±Ô∏è DRY-RUN</div>
                    <div class="legend-desc">rsync -ni Check f√ºr √Ñnderungen</div>
                </div>
                <div class="legend-item">
                    <div class="legend-label">‚ñ∂Ô∏è START</div>
                    <div class="legend-desc">Prozess beginnt</div>
                </div>
                <div class="legend-item">
                    <div class="legend-label">‚úÖ DONE</div>
                    <div class="legend-desc">Erfolgreich abgeschlossen</div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>üìñ Basierend auf: rtb_wrapper.sh | wrapper_pcloud_sync_1to1.sh | rsync_tmbackup.sh | safety_gate.sh</p>
        <p>üîê pCloud Backup Tools ‚Äì Production-Grade System mit Ransomware-Schutz</p>
    </footer>
</body>
</html>
